Abstract:
---------

A third example that demonstrates how to build PIE-optimized ELF executables
and PIC-optimized ELF shared libraries in a single build invocation.
And where the common library sources are generated by a genrule().

Compared to the second example, where the genrule() was run _twice_ in two
distinct host build configurations, this example tries to run it only _once_
by using transitions to a single "unique" build configuration, which requires
wrapping the genrule() call with a macro (named `unique_genrule()` here).


Testing:
------

Run the `run_tests.sh` in the workspace directory. (this fails).

Implementation Note:
--------------------

The `transitions-with-single-sources-generating-genrule` sample showed that
the host build configuration used to run a genrule() inherited the build
settings from the target build configuration of its dependents, i.e. in this
specific case the values of `copt` and `linkopt`.

This is incorrect (since these values are specific to the target build
configuration only) and also undesirable since it also creates two distinct
host build configurations instead of one, which results in the genrule() being
invoked twice to generate the same stuff

To try to work-around this, the current sample provides a wrapping macro named
`unique_genrule()` that wraps a genrule() around a transition to a "unique"
build configuration that removes any values in `copt` and `linkopt` that might
have been set by previous transitions. Note that this is a "parent target
build configuration".

This does work, as verified with the following commands (and where
`generate_common.genrule` is the name of the real genrule() target to run):

```sh
$ bazel cquery 'deps(//src:program)' 2>&1 | grep generate_common,genrule
//src:generate_common.genrule (99c3c74)

$ bazel cquery 'deps(//src:program2)' 2>&1 | grep generate_common.genrule
//src:generate_common.genrule (99c3c74)
```

Note that in the example above, 99c3c74 is a target build configuration,
the genrule() calls is the one making the transition to a host configuration
that can only be queried through the action graph:

```sh
$ bazel aquery 'deps(//src:program)' 2>&1
...
action 'Generating common library sources //src:generate_common.genrule'
  Mnemonic: Genrule
  Target: //src:generate_common.genrule
  Configuration: k8-fastbuild-ST-6f89e1bee3ea
  Execution platform: @local_config_platform//:host
  ActionKey: 447fba79899a4716e596dea7a2a223095c45538dc01570aa90d1208c8a89e69e
  Inputs: [external/bazel_tools/tools/genrule/genrule-setup.sh, src/generate_common_lib.sh]
  Outputs: [bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.cc, bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.h]
  Command Line: (exec /bin/bash \
    -c \
    'source external/bazel_tools/tools/genrule/genrule-setup.sh; ./src/generate_common_lib.sh bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.h bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.cc')
# Configuration: 99c3c74acf97f8d5a765a980143d530c169a0a241d9cb23180e8255fc1982ec4
# Execution platform: @local_config_platform//:host
...


$ bazel aquery 'deps(//src:program2)' 2>&1
...
action 'Generating common library sources //src:generate_common.genrule'
  Mnemonic: Genrule
  Target: //src:generate_common.genrule
  Configuration: k8-fastbuild-ST-6f89e1bee3ea
  Execution platform: @local_config_platform//:host
  ActionKey: 447fba79899a4716e596dea7a2a223095c45538dc01570aa90d1208c8a89e69e
  Inputs: [external/bazel_tools/tools/genrule/genrule-setup.sh, src/generate_common_lib.sh]
  Outputs: [bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.cc, bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.h]
  Command Line: (exec /bin/bash \
    -c \
    'source external/bazel_tools/tools/genrule/genrule-setup.sh; ./src/generate_common_lib.sh bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.h bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.cc')
# Configuration: 99c3c74acf97f8d5a765a980143d530c169a0a241d9cb23180e8255fc1982ec4
# Execution platform: @local_config_platform//:host

...
```

Which proves that both `//src:program` and `//src:program2` rely on the same
action to generate the sources of the common library, which will be stored
under `bazel-out/k8-fastbuild-ST-6f89e1bee3ea/`.


Issues / Unknowns / Future Work:
--------------------------------

A new problem arises though: the genrule outputs are no longer
visible to the sources that include the generated header:

```sh
# NOTE: output reformatted for easier reading.
$ bazel build '//src:program' --verbose_failures
...
ERROR: /work2/github-digit/bazel-experiments/pic-vs-pie/transitions-with-single-sources-generating-genrule/src/BUILD.bazel:41:14: Compiling src/program.cc failed: (Exit 1): gcc failed: error executing command /usr/bin/gcc -U_FORTIFY_SOURCE -fstack-protector -Wall -Wunused-but-set-parameter -Wno-free-nonheap-object -fno-omit-frame-pointer '-std=c++0x' -MD -MF ... (remaining 21 arguments skipped)

Use --sandbox_debug to see verbose messages from the sandbox and retain the sandbox build root for debugging
src/program.cc:1:10: fatal error: src/common.h: No such file or directory
    1 | #include "src/common.h"
      |          ^~~~~~~~~~~~~~
...
/usr/bin/gcc \
  -U_FORTIFY_SOURCE \
  -fstack-protector -Wall \
  -Wunused-but-set-parameter \
  -Wno-free-nonheap-object \
  -fno-omit-frame-pointer \
  '-std=c++0x' -MD -MF \
  bazel-out/k8-fastbuild-ST-bd2abcc18995/bin/src/_objs/program.binary/program.pic.d \
  '-frandom-seed=bazel-out/k8-fastbuild-ST-bd2abcc18995/bin/src/_objs/program.binary/program.pic.o' \
  -fPIC \
  -iquote . \
  -iquote bazel-out/k8-fastbuild-ST-bd2abcc18995/bin \
  -iquote external/bazel_tools \
  -iquote bazel-out/k8-fastbuild-ST-bd2abcc18995/bin/external/bazel_tools \
  -fPIE \
  -fno-canonical-system-headers \
  -Wno-builtin-macro-redefined \
  '-D__DATE__="redacted"' '-D__TIMESTAMP__="redacted"' '-D__TIME__="redacted"' \
  -c src/program.cc \
  -o bazel-out/k8-fastbuild-ST-bd2abcc18995/bin/src/_objs/program.binary/program.pic.o
```

The problem being that there is nothing to indicate where the generated sources
are. In practice, this would be an `-iquote bazel-out/k8-fastbuild-ST-6f89e1bee3ea` which is missing here.

Digging into the graph shows that the two 'common' cc_library() instances that
belong to the two PIC/PIE target build configurations have their `hdrs` and
`srcs` arguments pointing to the source files generated in the 'unique' build
configuration (all 3 of them have a different bazel-out/... output directory).

When compiing `//src:program` which needs to include the header, the latter
appears in the sandbox under `.../k8-fastbuild-ST-6f89e1bee3ea/bin` and not
`.../bazel-out/k8-fastbuild-ST-bd2abcc18995/bin` which is in the include
search path.


```sh
$ tree /usr/local/google/home/digit/.cache/bazel/_bazel_digit/202f677588d1e7cf681af6adfe9da54a/sandbox/linux-sandbox/19
/usr/local/google/home/digit/.cache/bazel/_bazel_digit/202f677588d1e7cf681af6adfe9da54a/sandbox/linux-sandbox/19
└── execroot
    └── __main__
        ├── bazel-out
        │   ├── k8-fastbuild-ST-6f89e1bee3ea
        │   │   └── bin
        │   │       └── src
        │   │           └── common.h -> /usr/local/google/home/digit/.cache/bazel/_bazel_digit/202f677588d1e7cf681af6adfe9da54a/execroot/__main__/bazel-out/k8-fastbuild-ST-6f89e1bee3ea/bin/src/common.h
        │   └── k8-fastbuild-ST-bd2abcc18995
        │       └── bin
        │           └── src
        │               └── _objs
        │                   └── program.binary
        ├── external
        │   ├── bazel_tools
        │   │   └── tools
        │   │       └── cpp
        │   │           └── grep-includes.sh -> /usr/local/google/home/digit/.cache/bazel/_bazel_digit/202f677588d1e7cf681af6adfe9da54a/execroot/__main__/external/bazel_tools/tools/cpp/grep-includes.sh
        │   └── local_config_cc
        │       └── builtin_include_directory_paths -> /usr/local/google/home/digit/.cache/bazel/_bazel_digit/202f677588d1e7cf681af6adfe9da54a/execroot/__main__/external/local_config_cc/builtin_include_directory_paths
        └── src
            └── program.cc -> /usr/local/google/home/digit/.cache/bazel/_bazel_digit/202f677588d1e7cf681af6adfe9da54a/execroot/__main__/src/program.cc

17 directories, 4 files
```
