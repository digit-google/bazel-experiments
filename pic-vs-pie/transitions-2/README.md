Abstract:
---------

A second example that demonstrate how to build PIE-optimized ELF executables and
PIC-optimized ELF shared libraries in a single build invocation. Where the
common library sources are generated by a genrule().

Testing:
------

Run the `run_tests.sh` in the workspace directory.

Implementation Note:
--------------------

The idea is to test that the genrule() is only run in a single host build
configuration. Unfortunately, that does not seem to be the case, instead
Bazel runs the same script in two different ones:

```sh
$ bazel clean --expunge
$ bazel build -s //src:program //src:program2
...

SUBCOMMAND: # //src:generate_common [action 'Generating common library sources //src:generate_common', configuration: 733d3243f57374b2e833420e45ad85927503fbfc5671ccca27ee9c741e1e07cf, execution platform: @local_config_platform//:host]
(cd /usr/local/google/home/digit/.cache/bazel/_bazel_digit/26ca9024e9424d11901d308739ff3cb5/execroot/__main__ && \
  exec env - \
    LD_LIBRARY_PATH=/usr/local/google/home/digit/local/lib \
    PATH=/usr/local/google/home/digit/.cargo/bin:/usr/local/google/home/digit/.local/bin:/usr/local/google/home/digit/local/bin:/usr/local/google/home/digit/local/bin:/usr/local/google/home/digit/.cargo/bin:/usr/local/google/home/digit/.local/bin:/usr/lib/google-golang/bin:/usr/local/buildtools/java/jdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \
  /bin/bash -c 'source external/bazel_tools/tools/genrule/genrule-setup.sh; ./src/generate_common_lib.sh bazel-out/k8-fastbuild-ST-ec22d3eeb595/bin/src/common.h bazel-out/k8-fastbuild-ST-ec22d3eeb595/bin/src/common.cc')
# Configuration: 733d3243f57374b2e833420e45ad85927503fbfc5671ccca27ee9c741e1e07cf
# Execution platform: @local_config_platform//:host

...

# Configuration: 733d3243f57374b2e833420e45ad85927503fbfc5671ccca27ee9c741e1e07cf
# Execution platform: @local_config_platform//:host
SUBCOMMAND: # //src:generate_common [action 'Generating common library sources //src:generate_common', configuration: 6167a43bee81d7c4ceebdf8986e0027b728c609e76e2c99eb3032efb76afa9e5, execution platform: @local_config_platform//:host]
(cd /usr/local/google/home/digit/.cache/bazel/_bazel_digit/26ca9024e9424d11901d308739ff3cb5/execroot/__main__ && \
  exec env - \
    LD_LIBRARY_PATH=/usr/local/google/home/digit/local/lib \
    PATH=/usr/local/google/home/digit/.cargo/bin:/usr/local/google/home/digit/.local/bin:/usr/local/google/home/digit/local/bin:/usr/local/google/home/digit/local/bin:/usr/local/google/home/digit/.cargo/bin:/usr/local/google/home/digit/.local/bin:/usr/lib/google-golang/bin:/usr/local/buildtools/java/jdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin \
  /bin/bash -c 'source external/bazel_tools/tools/genrule/genrule-setup.sh; ./src/generate_common_lib.sh bazel-out/k8-fastbuild/bin/src/common.h bazel-out/k8-fastbuild/bin/src/common.cc')
# Configuration: 4bed65880b8240e56a54b6500f119f311c9562d18e50951a7ef90692f2973e98
# Execution platform: @local_config_platform//:host

...
```

Inspection of the configuration shows that the host configurations can
inherit the copt / linkopt values from the source target build configuration:

```sh
diff -burN \
  <(bazel config 733d3243f5737) \
  <(bazel config 4bed65880b824) \

--- /dev/fd/63  2022-10-10 18:16:39.034343844 +0200
+++ /dev/fd/62  2022-10-10 18:16:39.034343844 +0200
@@ -1,5 +1,5 @@
-BuildConfiguration 733d3243f57374b2e833420e45ad85927503fbfc5671ccca27ee9c741e1e07cf:
-Skyframe Key: BuildConfigurationValue.Key[733d3243f57374b2e833420e45ad85927503fbfc5671ccca27ee9c741e1e07cf]
+BuildConfiguration 4bed65880b8240e56a54b6500f119f311c9562d18e50951a7ef90692f2973e98:
+Skyframe Key: BuildConfigurationValue.Key[4bed65880b8240e56a54b6500f119f311c9562d18e50951a7ef90692f2973e98]
 Fragments: com.google.devtools.build.lib.analysis.PlatformConfiguration: [com.google.devtools.build.lib.analysis.PlatformOptions], com.google.devtools.build.lib.analysis.ShellConfiguration: [com.google.devtools.build.lib.analysis.ShellConfiguration$Options], com.google.devtools.build.lib.analysis.test.CoverageConfiguration: [com.google.devtools.build.lib.analysis.config.CoreOptions,com.google.devtools.build.lib.analysis.test.CoverageConfiguration$CoverageOptions], com.google.devtools.build.lib.analysis.test.TestConfiguration: [com.google.devtools.build.lib.analysis.test.TestConfiguration$TestOptions], com.google.devtools.build.lib.bazel.rules.BazelRuleClassProvider$StrictActionEnvConfiguration: [com.google.devtools.build.lib.bazel.rules.BazelRuleClassProvider$StrictActionEnvOptions], com.google.devtools.build.lib.bazel.rules.python.BazelPythonConfiguration: [com.google.devtools.build.lib.bazel.rules.python.BazelPythonConfiguration$Options,com.google.devtools.build.lib.rules.python.PythonOptions], com.google.devtools.build.lib.rules.android.AndroidConfiguration: [com.google.devtools.build.lib.rules.android.AndroidConfiguration$Options], com.google.devtools.build.lib.rules.android.AndroidLocalTestConfiguration: [com.google.devtools.build.lib.rules.android.AndroidLocalTestConfiguration$Options], com.google.devtools.build.lib.rules.android.BazelAndroidConfiguration: [com.google.devtools.build.lib.rules.android.BazelAndroidConfiguration$Options], com.google.devtools.build.lib.rules.apple.AppleConfiguration: [com.google.devtools.build.lib.rules.apple.AppleCommandLineOptions], com.google.devtools.build.lib.rules.apple.swift.SwiftConfiguration: [com.google.devtools.build.lib.rules.apple.swift.SwiftCommandLineOptions], com.google.devtools.build.lib.rules.config.ConfigFeatureFlagConfiguration: [com.google.devtools.build.lib.rules.config.ConfigFeatureFlagOptions], com.google.devtools.build.lib.rules.cpp.CppConfiguration: [com.google.devtools.build.lib.rules.apple.AppleCommandLineOptions,com.google.devtools.build.lib.rules.cpp.CppOptions], com.google.devtools.build.lib.rules.genquery.GenQueryConfiguration: [com.google.devtools.build.lib.rules.genquery.GenQueryConfiguration$GenQueryOptions], com.google.devtools.build.lib.rules.java.JavaConfiguration: [com.google.devtools.build.lib.analysis.PlatformOptions,com.google.devtools.build.lib.rules.java.JavaOptions], com.google.devtools.build.lib.rules.objc.J2ObjcConfiguration: [com.google.devtools.build.lib.rules.objc.J2ObjcCommandLineOptions], com.google.devtools.build.lib.rules.objc.ObjcConfiguration: [com.google.devtools.build.lib.rules.cpp.CppOptions,com.google.devtools.build.lib.rules.objc.ObjcCommandLineOptions], com.google.devtools.build.lib.rules.proto.ProtoConfiguration: [com.google.devtools.build.lib.rules.proto.ProtoConfiguration$Options], com.google.devtools.build.lib.rules.python.PythonConfiguration: [com.google.devtools.build.lib.rules.python.PythonOptions], 
 FragmentOptions com.google.devtools.build.lib.analysis.PlatformOptions {
   experimental_add_exec_constraints_to_targets: []
@@ -202,7 +202,7 @@
   cc_output_directory_tag: 
   compiler: null
   conlyopt: []
-  copt: ["-fPIC"]
+  copt: ["-fPIE"]
   crosstool_top: @bazel_tools//tools/cpp:toolchain
   cs_fdo_absolute_path: null
   cs_fdo_instrument: null
@@ -260,7 +260,7 @@
   incompatible_validate_top_level_header_inclusions: true
   interface_shared_objects: true
   legacy_whole_archive: true
-  linkopt: ["-shared"]
+  linkopt: ["-pie"]
   ltobackendopt: []
   ltoindexopt: []
   minimum_os_version: null

```

Issues / Unknowns / Future Work:
--------------------------------

Interestingly, it is not possible to reference individual outputs of a
genrule() target, so intermediate filter_outputs() targets are needed to
achieve what we need. Note that these targets do not build anything, they
just carry DefaultInfo providers to their dependents.

TODO: Use yet another build configuration and transition function to ensure
that the generating rule is only run once per build.
